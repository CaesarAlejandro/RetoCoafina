name: CI - Pruebas del Web Service

on:
  push:
    branches-ignore:
      - main
  pull_request:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: (CI) Construir la imagen Docker
        run: docker build -t fisico-robot .

      - name: (CI) Ejecutar pruebas unitarias dentro del contenedor
        run: docker run --rm -v "$GITHUB_WORKSPACE":/app -w /app fisico-robot pytest -q

      - name: (CI) Ejecutar notebook y generar Front/
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE":/app -w /app fisico-robot bash -lc "\
            if [ -f 'ArchivosPython/analysis.ipynb' ]; then \
              python -m nbconvert --to notebook --execute 'ArchivosPython/analysis.ipynb' --output 'ArchivosPython/executed.ipynb' --ExecutePreprocessor.timeout=600 && \
              python -m nbconvert --to html 'ArchivosPython/executed.ipynb' --output-dir=Front --output=index.html ; \
            else \
              echo 'No notebook found: ArchivosPython/analysis.ipynb, se salta generaciÃ³n'; \
            fi"

      - name: (CI) Verificar contenidos de Front
        run: |
          echo "Listado workspace:"
          ls -la
          echo "Listado Front/:"
          ls -la Front || { echo "ERROR: Front/ no existe"; exit 1; }
          [ -f Front/index.html ] || { echo "ERROR: Front/index.html faltante"; exit 1; }
          sh -c 'ls Front/*.png 2>/dev/null' || echo "WARNING: No PNGs en Front/ (puede ser esperado)"

      - name: (CI) Configurar GitHub Pages
        uses: actions/configure-pages@v4

      - name: (CI) Subir carpeta Front a Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'Front'